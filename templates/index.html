<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Reconnaissance du compteur dâ€™eau</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <style>
        * { box-sizing: border-box; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        header { background: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { margin: 0; color: #1a73e8; }
        .status { margin-top: 10px; display: inline-block; padding: 6px 16px; border-radius: 20px; background: #fff3cd; color: #856404; font-weight: bold; font-size: 14px; }

        .card { background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .upload-area { border: 3px dashed #dfe1e5; border-radius: 15px; padding: 50px; text-align: center; cursor: pointer; transition: 0.3s; }
        .upload-area:hover { border-color: #1a73e8; background: #f8fbff; }
        .upload-icon { font-size: 48px; margin-bottom: 10px; }

        .preview { display: none; margin-top: 20px; text-align: center; }
        .preview img { max-width: 100%; max-height: 300px; border-radius: 10px; border: 1px solid #ddd; }

        .controls { margin-top: 25px; display: flex; justify-content: center; gap: 15px; }
        button { padding: 14px 28px; font-size: 16px; font-weight: 600; border-radius: 8px; border: none; cursor: pointer; }
        .process-btn { background: #1a73e8; color: white; }
        .process-btn:disabled { background: #ccc; cursor: not-allowed; }
        .reset-btn { background: #f1f3f4; }

        .loading { display: none; text-align: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid #1a73e8; border-radius: 50%; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .results { display: none; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .reading-box { background: #1a73e8; color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 25px; }
        .reading-value { font-size: 64px; font-family: "Courier New", monospace; letter-spacing: 8px; font-weight: 800; }

        .display-container { display: grid; grid-template-columns: 1fr 360px; gap: 20px; }
        @media (max-width: 900px) { .display-container { grid-template-columns: 1fr; } }

        .image-box { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .image-box h3 { font-size: 13px; color: #5f6368; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; }
        .image-box img { width: 100%; border-radius: 8px; }
        .crop-img { border: 2px solid #1a73e8; }
    </style>
</head>

<body>
<div class="container">

    <header>
        <h1>ðŸ’§ Lecteur de compteur dâ€™eau</h1>
        <div class="status" id="status">Statut du modÃ¨le : vÃ©rificationâ€¦</div>
    </header>

    <div class="card">
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ðŸ“¸</div>
            <p><strong>Cliquez pour importer</strong> ou glissez une image ici</p>
            <input type="file" id="fileInput" accept="image/*" hidden>
        </div>

        <div class="preview" id="preview">
            <img id="previewImg">
        </div>

        <div class="controls">
            <button class="process-btn" id="processBtn" disabled>Analyser</button>
            <button class="reset-btn" id="resetBtn">RÃ©initialiser</button>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Lâ€™IA analyse le compteurâ€¦</p>
    </div>

    <div class="results" id="results">
        <div class="reading-box">
            <p>Index dÃ©tectÃ©</p>
            <div class="reading-value" id="reading">----</div>
            <p>Confiance : <span id="confidence">0%</span></p>
        </div>

        <div class="display-container">
            <div class="image-box">
                <h3>DÃ©tection complÃ¨te</h3>
                <img id="resultImg">
            </div>

            <div class="image-box">
                <h3>Zoom chiffres (ROI)</h3>
                <img id="cropImg" class="crop-img">
            </div>
        </div>
    </div>

</div>

<script>
const statusEl = document.getElementById("status");
const uploadArea = document.getElementById("uploadArea");
const fileInput = document.getElementById("fileInput");
const processBtn = document.getElementById("processBtn");

// 1ï¸âƒ£ Poll model status every 2 seconds
async function updateStatus() {
    try {
        const res = await fetch("/status");
        const data = await res.json();

        if (data.yolo_loaded) {
            statusEl.textContent = "Statut du modÃ¨le : prÃªt";
            statusEl.style.background = "#d4edda";
            statusEl.style.color = "#155724";
        } else {
            statusEl.textContent = "Statut du modÃ¨le : chargement du modÃ¨leâ€¦";
            statusEl.style.background = "#fff3cd";
            statusEl.style.color = "#856404";
        }
    } catch {
        statusEl.textContent = "Statut du modÃ¨le : hors ligne";
        statusEl.style.background = "#f8d7da";
        statusEl.style.color = "#721c24";
    }
}
setInterval(updateStatus, 2000);
updateStatus();

// 2ï¸âƒ£ File upload & preview
uploadArea.onclick = () => fileInput.click();
fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        document.getElementById("previewImg").src = e.target.result;
        document.getElementById("preview").style.display = "block";
        processBtn.disabled = false;
    };
    reader.readAsDataURL(file);
};

// 3ï¸âƒ£ Analyze button
processBtn.onclick = async () => {
    processBtn.disabled = true;
    document.getElementById("loading").style.display = "block";
    document.getElementById("results").style.display = "none";

    const formData = new FormData();
    formData.append("image", fileInput.files[0]);

    try {
        const res = await fetch("/upload", { method: "POST", body: formData });
        const data = await res.json();

        if (!data.success) {
            alert("Erreur : " + data.error);
            location.reload();
            return;
        }

        const t = Date.now(); // prevent caching
        document.getElementById("reading").textContent = data.reading;
        document.getElementById("confidence").textContent = data.confidence;
        document.getElementById("resultImg").src = "/uploads/" + data.image_url.split("/").pop() + "?t=" + t;

        if (data.crops && data.crops.length > 0) {
            document.getElementById("cropImg").src = "/uploads/" + data.crops[0] + "?t=" + t;
        }

        document.getElementById("loading").style.display = "none";
        document.getElementById("results").style.display = "block";

    } catch (err) {
        alert("Ã‰chec de lâ€™upload. Le serveur est-il dÃ©marrÃ© ?");
        console.error(err);
        location.reload();
    }
};

// 4ï¸âƒ£ Reset button
document.getElementById("resetBtn").onclick = () => location.reload();
</script>

</body>
</html>
